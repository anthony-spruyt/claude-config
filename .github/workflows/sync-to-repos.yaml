name: Sync to Target Repos

on:
  push:
    branches: [main]
    paths:
      - ".claude/**"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  sync-all-installations:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Import GPG key
        id: import-gpg
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}
          git_user_signingkey: true
          git_commit_gpgsign: true

      - name: Setup Git
        run: |
          git config --global user.name "${{ steps.import-gpg.outputs.name }}"
          git config --global user.email "${{ steps.import-gpg.outputs.email }}"

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Generate GitHub App JWT
        id: app-jwt
        env:
          APP_ID: ${{ secrets.APP_ID }}
          APP_PRIVATE_KEY: ${{ secrets.APP_PRIVATE_KEY }}
        run: |
          # Generate JWT for GitHub App authentication
          # Based on: https://docs.github.com/en/apps/creating-github-apps/authenticating-with-a-github-app/generating-a-json-web-token-jwt-for-a-github-app

          NOW=$(date +%s)
          IAT=$((NOW - 60))
          EXP=$((NOW + 600))

          # Write private key to temp file (handles both escaped \n and real newlines)
          KEY_FILE=$(mktemp)
          printf '%s' "$APP_PRIVATE_KEY" | sed -e $'s/\\\\n/\\\n/g' > "$KEY_FILE"

          # Create JWT header and payload
          HEADER=$(printf '%s' '{"alg":"RS256","typ":"JWT"}' | base64 -w 0 | tr -d '=' | tr '/+' '_-')
          PAYLOAD=$(printf '%s' "{\"iat\":${IAT},\"exp\":${EXP},\"iss\":\"${APP_ID}\"}" | base64 -w 0 | tr -d '=' | tr '/+' '_-')

          # Sign with private key
          SIGNATURE=$(printf '%s' "${HEADER}.${PAYLOAD}" | openssl dgst -sha256 -sign "$KEY_FILE" -binary | base64 -w 0 | tr -d '=' | tr '/+' '_-')

          # Clean up key file
          rm -f "$KEY_FILE"

          JWT="${HEADER}.${PAYLOAD}.${SIGNATURE}"

          # Mask the JWT in logs and output
          echo "::add-mask::${JWT}"
          echo "jwt=${JWT}" >> "$GITHUB_OUTPUT"

      - name: Sync to all installations
        env:
          APP_JWT: ${{ steps.app-jwt.outputs.jwt }}
        run: |
          total_repos=0
          failed_repos=""

          # Get all installations using curl (gh cli has issues with JWT auth)
          echo "Getting all installations..."
          installations_response=$(curl -s --max-time 30 -w '\n%{http_code}' \
            -H "Authorization: Bearer $APP_JWT" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/app/installations)
          http_code="${installations_response##*$'\n'}"
          installations_body="${installations_response%$'\n'*}"

          if [ "$http_code" != "200" ]; then
            echo "âŒ Failed to get installations (HTTP $http_code)"
            echo "$installations_body" | head -5
            exit 1
          fi

          echo "$installations_body" | jq -r '.[] | "\(.id):\(.account.login)"' > installations.txt

          echo "Found $(wc -l < installations.txt) installations:"
          cat installations.txt

          # Process each installation
          while IFS=: read -r installation_id owner; do
            echo ""
            echo "========================================"
            echo "Processing installation ${installation_id} (${owner})"
            echo "========================================"

            # Get installation token using curl
            token_response=$(curl -s --max-time 30 -w '\n%{http_code}' -X POST \
              -H "Authorization: Bearer $APP_JWT" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/app/installations/${installation_id}/access_tokens")
            http_code="${token_response##*$'\n'}"
            token_body="${token_response%$'\n'*}"
            token=$(echo "$token_body" | jq -r '.token')

            if [ "$http_code" != "201" ] || [ -z "$token" ] || [ "$token" = "null" ]; then
              echo "âš ï¸  Failed to get token for installation ${installation_id} (HTTP $http_code)"
              continue
            fi

            # Mask token in logs
            echo "::add-mask::${token}"

            # Get repos for this installation using curl
            repos_response=$(curl -s --max-time 30 -w '\n%{http_code}' \
              -H "Authorization: Bearer $token" \
              -H "Accept: application/vnd.github+json" \
              https://api.github.com/installation/repositories)
            repos_http_code="${repos_response##*$'\n'}"
            repos_body="${repos_response%$'\n'*}"

            if [ "$repos_http_code" != "200" ]; then
              echo "âš ï¸  Failed to get repos for installation ${installation_id} (HTTP $repos_http_code)"
              continue
            fi

            repos=$(echo "$repos_body" | jq -r '.repositories[].full_name')

            # Sync to each repo
            for repo in $repos; do
              echo ""
              echo "Syncing to ${repo}..."
              if GH_TOKEN="${token}" ./sync-to-repo.sh "$repo" "$GITHUB_REPOSITORY" main; then
                ((total_repos++)) || true
              else
                echo "âš ï¸  Failed to sync $repo"
                failed_repos="${failed_repos} ${repo}"
              fi
            done
          done < installations.txt

          echo ""
          echo "========================================"
          echo "âœ… Sync complete: ${total_repos} repositories processed"
          echo "========================================"

          if [ -n "$failed_repos" ]; then
            echo ""
            echo "âš ï¸  Warning: Failed to sync:${failed_repos}"
          fi

          # Write job summary
          {
            echo "## ðŸ”„ Config Sync Summary"
            echo ""
            echo "| Metric | Value |"
            echo "|--------|-------|"
            echo "| Repositories processed | ${total_repos} |"
            echo "| Installations | $(wc -l < installations.txt) |"
            if [ -n "$failed_repos" ]; then
              echo "| Status | âš ï¸ Partial success |"
              echo ""
              echo "### âŒ Failed Repositories"
              echo ""
              for repo in $failed_repos; do
                echo "- \`${repo}\`"
              done
            else
              echo "| Status | âœ… All synced |"
            fi
          } >> "$GITHUB_STEP_SUMMARY"
