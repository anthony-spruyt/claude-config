name: Sync to Target Repos

on:
  push:
    branches: [main]
    paths:
      - ".claude/**"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  sync-all-installations:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Generate GitHub App JWT
        id: app-jwt
        env:
          APP_ID: ${{ secrets.APP_ID }}
          APP_PRIVATE_KEY: ${{ secrets.APP_PRIVATE_KEY }}
        run: |
          # Generate JWT for GitHub App authentication
          # Based on: https://docs.github.com/en/apps/creating-github-apps/authenticating-with-a-github-app/generating-a-json-web-token-jwt-for-a-github-app

          NOW=$(date +%s)
          IAT=$((NOW - 60))
          EXP=$((NOW + 600))

          # Write private key to temp file (handles both escaped \n and real newlines)
          KEY_FILE=$(mktemp)
          printf '%s' "$APP_PRIVATE_KEY" | sed -e $'s/\\\\n/\\\n/g' > "$KEY_FILE"

          # Create JWT header and payload
          HEADER=$(printf '%s' '{"alg":"RS256","typ":"JWT"}' | base64 -w 0 | tr -d '=' | tr '/+' '_-')
          PAYLOAD=$(printf '%s' "{\"iat\":${IAT},\"exp\":${EXP},\"iss\":\"${APP_ID}\"}" | base64 -w 0 | tr -d '=' | tr '/+' '_-')

          # Sign with private key
          SIGNATURE=$(printf '%s' "${HEADER}.${PAYLOAD}" | openssl dgst -sha256 -sign "$KEY_FILE" -binary | base64 -w 0 | tr -d '=' | tr '/+' '_-')

          # Clean up key file
          rm -f "$KEY_FILE"

          JWT="${HEADER}.${PAYLOAD}.${SIGNATURE}"

          # Mask the JWT in logs and output
          echo "::add-mask::${JWT}"
          echo "jwt=${JWT}" >> "$GITHUB_OUTPUT"

      - name: Sync to all installations
        env:
          APP_JWT: ${{ steps.app-jwt.outputs.jwt }}
        run: |
          total_repos=0

          # Get all installations using curl (gh cli has issues with JWT auth)
          echo "Getting all installations..."
          curl -s -H "Authorization: Bearer $APP_JWT" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/app/installations | jq -r '.[] | "\(.id):\(.account.login)"' > installations.txt

          echo "Found $(wc -l < installations.txt) installations:"
          cat installations.txt

          # Process each installation
          while IFS=: read -r installation_id owner; do
            echo ""
            echo "========================================"
            echo "Processing installation ${installation_id} (${owner})"
            echo "========================================"

            # Get installation token using curl
            token=$(curl -s -X POST \
              -H "Authorization: Bearer $APP_JWT" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/app/installations/${installation_id}/access_tokens" | jq -r '.token')

            if [ -z "$token" ] || [ "$token" = "null" ]; then
              echo "⚠️  Failed to get token for installation ${installation_id}"
              continue
            fi

            # Get repos for this installation using curl
            repos=$(curl -s -H "Authorization: Bearer $token" \
              -H "Accept: application/vnd.github+json" \
              https://api.github.com/installation/repositories | jq -r '.repositories[].full_name')

            # Sync to each repo
            for repo in $repos; do
              echo ""
              echo "Syncing to ${repo}..."
              GH_TOKEN="${token}" ./sync-to-repo.sh "$repo" "$GITHUB_REPOSITORY" main || echo "⚠️  Failed to sync $repo (continuing...)"
              ((total_repos++)) || true
            done
          done < installations.txt

          echo ""
          echo "========================================"
          echo "✅ Sync complete: ${total_repos} repositories processed"
          echo "========================================"
