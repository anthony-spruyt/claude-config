# Hookify Test Cases
# Data-driven test configuration for hookify rules
#
# Format:
#   - name: descriptive test name
#     tool: Bash (or Read/Edit/Write)
#     command: the command to test (for Bash tool)
#     expect: block | warn | allow

test_cases:
  # =============================================================================
  # SOPS Decryption (block-sops-decrypt)
  # =============================================================================
  - name: "block-sops-decrypt: sops -d"
    tool: Bash
    command: "sops -d secrets.yaml"
    expect: block

  - name: "block-sops-decrypt: sops --decrypt"
    tool: Bash
    command: "sops --decrypt config.enc"
    expect: block

  - name: "block-sops-decrypt: sops exec-env"
    tool: Bash
    command: "sops exec-env secrets.yaml 'printenv'"
    expect: block

  - name: "block-sops-decrypt: sops exec-file"
    tool: Bash
    command: "sops exec-file secrets.yaml 'cat {}'"
    expect: block

  - name: "block-sops-decrypt: allows sops -e (encrypt)"
    tool: Bash
    command: "sops -e secrets.yaml"
    expect: allow

  - name: "block-sops-decrypt: allows sops --version"
    tool: Bash
    command: "sops --version"
    expect: allow

  # =============================================================================
  # Environment Variable Grep (block-env-grep)
  # =============================================================================
  - name: "block-env-grep: env | grep"
    tool: Bash
    command: "env | grep SECRET"
    expect: block

  - name: "block-env-grep: printenv | grep"
    tool: Bash
    command: "printenv | grep TOKEN"
    expect: block

  # NOTE: These are blocked by block-env-dump rule (env with pipe) even though
  # block-env-dump message lists "env | cut" as a safe alternative. Rule bug.
  - name: "block-env-grep: env | cut blocked by env-dump"
    tool: Bash
    command: "env | cut -d= -f1"
    expect: block

  - name: "block-env-grep: env | wc blocked by env-dump"
    tool: Bash
    command: "env | wc -l"
    expect: block

  # =============================================================================
  # Environment Dump (block-env-dump)
  # =============================================================================
  - name: "block-env-dump: standalone env"
    tool: Bash
    command: "env"
    expect: block

  - name: "block-env-dump: env with pipe"
    tool: Bash
    command: "env | head"
    expect: block

  - name: "block-env-dump: chained env"
    tool: Bash
    command: "mkdir /tmp && env"
    expect: block

  - name: "block-env-dump: allows env VAR=value command"
    tool: Bash
    command: "env PATH=/bin command"
    expect: allow

  # =============================================================================
  # Printenv (block-printenv)
  # =============================================================================
  - name: "block-printenv: standalone printenv"
    tool: Bash
    command: "printenv"
    expect: block

  - name: "block-printenv: printenv with variable"
    tool: Bash
    command: "printenv SECRET_KEY"
    expect: block

  - name: "block-printenv: chained printenv"
    tool: Bash
    command: "ls && printenv"
    expect: block

  # =============================================================================
  # Process Environ (block-proc-environ)
  # =============================================================================
  - name: "block-proc-environ: cat /proc/self/environ"
    tool: Bash
    command: "cat /proc/self/environ"
    expect: block

  - name: "block-proc-environ: cat /proc/$$/environ"
    tool: Bash
    command: "cat /proc/$$/environ"
    expect: block

  - name: "block-proc-environ: cat /proc/1234/environ"
    tool: Bash
    command: "cat /proc/1234/environ"
    expect: block

  # NOTE: cat /proc/cpuinfo warns due to warn-use-read-tool (use Read tool instead)
  - name: "block-proc-environ: cat /proc/cpuinfo warns"
    tool: Bash
    command: "cat /proc/cpuinfo"
    expect: warn

  # =============================================================================
  # Kubectl Secrets (block-kubectl-s3crets)
  # =============================================================================
  - name: "block-kubectl-s3crets: kubectl get secret -o yaml"
    tool: Bash
    command: "kubectl get secret my-secret -o yaml"
    expect: block

  - name: "block-kubectl-s3crets: kubectl get secret -o go-template"
    tool: Bash
    command: "kubectl get secret my-secret -o go-template='{{.data.password}}'"
    expect: block

  - name: "block-kubectl-s3crets: allows plain kubectl get secrets"
    tool: Bash
    command: "kubectl get secrets"
    expect: allow

  # =============================================================================
  # Kubectl Describe Secrets (block-kubectl-describe-s3crets)
  # =============================================================================
  - name: "block-kubectl-describe-s3crets: kubectl describe secret"
    tool: Bash
    command: "kubectl describe secret my-secret"
    expect: block

  - name: "block-kubectl-describe-s3crets: kubectl describe secrets"
    tool: Bash
    command: "kubectl describe secrets"
    expect: block

  - name: "block-kubectl-describe-s3crets: allows kubectl describe pod"
    tool: Bash
    command: "kubectl describe pod my-pod"
    expect: allow

  # =============================================================================
  # Base64 Decode (block-base64-decode)
  # =============================================================================
  - name: "block-base64-decode: base64 -d"
    tool: Bash
    command: "base64 -d secret.txt"
    expect: block

  - name: "block-base64-decode: base64 --decode"
    tool: Bash
    command: "base64 --decode secret.txt"
    expect: block

  - name: "block-base64-decode: base64 -D (BSD)"
    tool: Bash
    command: "base64 -D secret.txt"
    expect: block

  - name: "block-base64-decode: allows base64 encode"
    tool: Bash
    command: "echo 'test' | base64"
    expect: allow

  # =============================================================================
  # GPG Decrypt (block-gpg-decrypt)
  # =============================================================================
  - name: "block-gpg-decrypt: gpg -d"
    tool: Bash
    command: "gpg -d secrets.gpg"
    expect: block

  - name: "block-gpg-decrypt: gpg --decrypt"
    tool: Bash
    command: "gpg --decrypt secrets.gpg"
    expect: block

  - name: "block-gpg-decrypt: allows gpg --encrypt"
    tool: Bash
    command: "gpg --encrypt -r user@example.com file"
    expect: allow

  - name: "block-gpg-decrypt: allows gpg --list-keys"
    tool: Bash
    command: "gpg --list-keys"
    expect: allow

  # =============================================================================
  # OpenSSL Decrypt (block-openssl-decrypt)
  # =============================================================================
  - name: "block-openssl-decrypt: openssl enc -d"
    tool: Bash
    command: "openssl enc -d -aes-256-cbc -in file.enc"
    expect: block

  - name: "block-openssl-decrypt: openssl pkcs12"
    tool: Bash
    command: "openssl pkcs12 -in cert.p12"
    expect: block

  - name: "block-openssl-decrypt: allows openssl x509"
    tool: Bash
    command: "openssl x509 -in cert.pem -text"
    expect: allow

  - name: "block-openssl-decrypt: allows openssl genrsa"
    tool: Bash
    command: "openssl genrsa -out key.pem 2048"
    expect: allow

  # =============================================================================
  # Age Decrypt (block-age-decrypt)
  # =============================================================================
  - name: "block-age-decrypt: age -d"
    tool: Bash
    command: "age -d -i key.txt file.age"
    expect: block

  - name: "block-age-decrypt: age --decrypt"
    tool: Bash
    command: "age --decrypt file.age"
    expect: block

  - name: "block-age-decrypt: allows age encrypt"
    tool: Bash
    command: "age -r recipient -o file.age file"
    expect: allow

  - name: "block-age-decrypt: allows age-keygen"
    tool: Bash
    command: "age-keygen -o key.txt"
    expect: allow

  # =============================================================================
  # GitHub Issue Close (block-issue-close)
  # =============================================================================
  - name: "block-issue-close: gh issue close"
    tool: Bash
    command: "gh issue close 123"
    expect: block

  - name: "block-issue-close: allows gh issue list"
    tool: Bash
    command: "gh issue list"
    expect: allow

  # =============================================================================
  # Shell Wrappers (warn-shell-wrappers)
  # =============================================================================
  - name: "warn-shell-wrappers: sh -c"
    tool: Bash
    command: "sh -c 'echo hello'"
    expect: warn

  - name: "warn-shell-wrappers: bash -c"
    tool: Bash
    command: "bash -c 'cat file'"
    expect: warn

  - name: "warn-shell-wrappers: eval"
    tool: Bash
    command: "eval 'printenv'"
    expect: warn

  - name: "warn-shell-wrappers: chained sh -c"
    tool: Bash
    command: "mkdir /tmp && sh -c 'cat /etc/passwd'"
    expect: warn

  - name: "warn-shell-wrappers: allows plain bash"
    tool: Bash
    command: "bash script.sh"
    expect: allow

  # =============================================================================
  # Use Read Tool (warn-use-read-tool)
  # =============================================================================
  - name: "warn-use-read-tool: cat file"
    tool: Bash
    command: "cat README.md"
    expect: warn

  - name: "warn-use-read-tool: cat chained"
    tool: Bash
    command: "cd /workspaces && cat /workspaces/providers.tf"
    expect: warn

  - name: "warn-use-read-tool: head file"
    tool: Bash
    command: "head -n 50 file.txt"
    expect: warn

  - name: "warn-use-read-tool: tail file"
    tool: Bash
    command: "tail -f logfile"
    expect: warn

  - name: "warn-use-read-tool: cat file | grep"
    tool: Bash
    command: "cat file.txt | grep pattern"
    expect: warn

  # =============================================================================
  # Use Grep Tool (warn-use-grep-tool)
  # =============================================================================
  - name: "warn-use-grep-tool: grep pattern"
    tool: Bash
    command: "grep 'TODO' src/"
    expect: warn

  - name: "warn-use-grep-tool: rg pattern"
    tool: Bash
    command: "rg 'function' --type js"
    expect: warn

  # =============================================================================
  # Use Edit Tool (warn-use-edit-tool)
  # =============================================================================
  - name: "warn-use-edit-tool: sed -i"
    tool: Bash
    command: "sed -i 's/old/new/g' file.txt"
    expect: warn

  - name: "warn-use-edit-tool: allows sed without -i"
    tool: Bash
    command: "sed 's/old/new/g' file.txt"
    expect: allow

  # =============================================================================
  # Use Glob Tool (warn-use-glob-tool)
  # =============================================================================
  - name: "warn-use-glob-tool: find path"
    tool: Bash
    command: "find . -name '*.ts'"
    expect: warn

  - name: "warn-use-glob-tool: ls directory"
    tool: Bash
    command: "ls -la src/"
    expect: warn

  - name: "warn-use-glob-tool: allows bare ls"
    tool: Bash
    command: "ls"
    expect: allow
