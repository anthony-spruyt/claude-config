# Hookify Test Cases
# Data-driven test configuration for hookify rules
#
# Format:
#   - name: descriptive test name
#     tool: Bash (or Read/Edit/Write)
#     command: the command to test (for Bash tool)
#     expect: block | warn | allow

test_cases:
  # =============================================================================
  # SOPS Decryption (block-sops-decrypt)
  # =============================================================================
  - name: "block-sops-decrypt: sops -d"
    tool: Bash
    command: "sops -d secrets.yaml"
    expect: block

  - name: "block-sops-decrypt: sops --decrypt"
    tool: Bash
    command: "sops --decrypt config.enc"
    expect: block

  - name: "block-sops-decrypt: sops exec-env"
    tool: Bash
    command: "sops exec-env secrets.yaml 'printenv'"
    expect: block

  - name: "block-sops-decrypt: sops exec-file"
    tool: Bash
    command: "sops exec-file secrets.yaml 'cat {}'"
    expect: block

  - name: "block-sops-decrypt: allows sops -e (encrypt)"
    tool: Bash
    command: "sops -e secrets.yaml"
    expect: allow

  - name: "block-sops-decrypt: allows sops --version"
    tool: Bash
    command: "sops --version"
    expect: allow

  # =============================================================================
  # Environment Variable Grep (block-env-grep)
  # =============================================================================
  - name: "block-env-grep: env | grep"
    tool: Bash
    command: "env | grep SECRET"
    expect: block

  - name: "block-env-grep: printenv | grep"
    tool: Bash
    command: "printenv | grep TOKEN"
    expect: block

  # NOTE: These are blocked by block-env-dump rule (env with pipe) even though
  # block-env-dump message lists "env | cut" as a safe alternative. Rule bug.
  - name: "block-env-grep: env | cut blocked by env-dump"
    tool: Bash
    command: "env | cut -d= -f1"
    expect: block

  - name: "block-env-grep: env | wc blocked by env-dump"
    tool: Bash
    command: "env | wc -l"
    expect: block

  # =============================================================================
  # Environment Dump (block-env-dump)
  # =============================================================================
  - name: "block-env-dump: standalone env"
    tool: Bash
    command: "env"
    expect: block

  - name: "block-env-dump: env with pipe"
    tool: Bash
    command: "env | head"
    expect: block

  - name: "block-env-dump: chained env"
    tool: Bash
    command: "mkdir /tmp && env"
    expect: block

  - name: "block-env-dump: allows env VAR=value command"
    tool: Bash
    command: "env PATH=/bin command"
    expect: allow

  # =============================================================================
  # Printenv (block-printenv)
  # =============================================================================
  - name: "block-printenv: standalone printenv"
    tool: Bash
    command: "printenv"
    expect: block

  - name: "block-printenv: printenv with variable"
    tool: Bash
    command: "printenv SECRET_KEY"
    expect: block

  - name: "block-printenv: chained printenv"
    tool: Bash
    command: "ls && printenv"
    expect: block

  # =============================================================================
  # Process Environ (block-proc-environ)
  # =============================================================================
  - name: "block-proc-environ: cat /proc/self/environ"
    tool: Bash
    command: "cat /proc/self/environ"
    expect: block

  - name: "block-proc-environ: cat /proc/$$/environ"
    tool: Bash
    command: "cat /proc/$$/environ"
    expect: block

  - name: "block-proc-environ: cat /proc/1234/environ"
    tool: Bash
    command: "cat /proc/1234/environ"
    expect: block

  # NOTE: cat /proc/cpuinfo warns due to warn-use-read-tool (use Read tool instead)
  - name: "block-proc-environ: cat /proc/cpuinfo warns"
    tool: Bash
    command: "cat /proc/cpuinfo"
    expect: warn

  # =============================================================================
  # Kubectl Secrets (block-kubectl-s3crets)
  # =============================================================================
  - name: "block-kubectl-s3crets: kubectl get secret -o yaml"
    tool: Bash
    command: "kubectl get secret my-secret -o yaml"
    expect: block

  - name: "block-kubectl-s3crets: kubectl get secret -o go-template"
    tool: Bash
    command: "kubectl get secret my-secret -o go-template='{{.data.password}}'"
    expect: block

  - name: "block-kubectl-s3crets: allows plain kubectl get secrets"
    tool: Bash
    command: "kubectl get secrets"
    expect: allow

  # =============================================================================
  # Kubectl Describe Secrets (block-kubectl-describe-s3crets)
  # =============================================================================
  - name: "block-kubectl-describe-s3crets: kubectl describe secret"
    tool: Bash
    command: "kubectl describe secret my-secret"
    expect: block

  - name: "block-kubectl-describe-s3crets: kubectl describe secrets"
    tool: Bash
    command: "kubectl describe secrets"
    expect: block

  - name: "block-kubectl-describe-s3crets: allows kubectl describe pod"
    tool: Bash
    command: "kubectl describe pod my-pod"
    expect: allow

  # =============================================================================
  # Base64 Decode (block-base64-decode)
  # =============================================================================
  - name: "block-base64-decode: base64 -d"
    tool: Bash
    command: "base64 -d secret.txt"
    expect: block

  - name: "block-base64-decode: base64 --decode"
    tool: Bash
    command: "base64 --decode secret.txt"
    expect: block

  - name: "block-base64-decode: base64 -D (BSD)"
    tool: Bash
    command: "base64 -D secret.txt"
    expect: block

  - name: "block-base64-decode: allows base64 encode"
    tool: Bash
    command: "echo 'test' | base64"
    expect: allow

  # =============================================================================
  # GPG Decrypt (block-gpg-decrypt)
  # =============================================================================
  - name: "block-gpg-decrypt: gpg -d"
    tool: Bash
    command: "gpg -d secrets.gpg"
    expect: block

  - name: "block-gpg-decrypt: gpg --decrypt"
    tool: Bash
    command: "gpg --decrypt secrets.gpg"
    expect: block

  - name: "block-gpg-decrypt: allows gpg --encrypt"
    tool: Bash
    command: "gpg --encrypt -r user@example.com file"
    expect: allow

  - name: "block-gpg-decrypt: allows gpg --list-keys"
    tool: Bash
    command: "gpg --list-keys"
    expect: allow

  # =============================================================================
  # OpenSSL Decrypt (block-openssl-decrypt)
  # =============================================================================
  - name: "block-openssl-decrypt: openssl enc -d"
    tool: Bash
    command: "openssl enc -d -aes-256-cbc -in file.enc"
    expect: block

  - name: "block-openssl-decrypt: openssl pkcs12"
    tool: Bash
    command: "openssl pkcs12 -in cert.p12"
    expect: block

  - name: "block-openssl-decrypt: allows openssl x509"
    tool: Bash
    command: "openssl x509 -in cert.pem -text"
    expect: allow

  - name: "block-openssl-decrypt: allows openssl genrsa"
    tool: Bash
    command: "openssl genrsa -out key.pem 2048"
    expect: allow

  # =============================================================================
  # Age Decrypt (block-age-decrypt)
  # =============================================================================
  - name: "block-age-decrypt: age -d"
    tool: Bash
    command: "age -d -i key.txt file.age"
    expect: block

  - name: "block-age-decrypt: age --decrypt"
    tool: Bash
    command: "age --decrypt file.age"
    expect: block

  - name: "block-age-decrypt: allows age encrypt"
    tool: Bash
    command: "age -r recipient -o file.age file"
    expect: allow

  - name: "block-age-decrypt: allows age-keygen"
    tool: Bash
    command: "age-keygen -o key.txt"
    expect: allow

  # =============================================================================
  # GitHub Issue Close (block-issue-close)
  # =============================================================================
  - name: "block-issue-close: gh issue close"
    tool: Bash
    command: "gh issue close 123"
    expect: block

  - name: "block-issue-close: allows gh issue list"
    tool: Bash
    command: "gh issue list"
    expect: allow

  # =============================================================================
  # Shell Wrappers (warn-shell-wrappers)
  # =============================================================================
  - name: "warn-shell-wrappers: sh -c"
    tool: Bash
    command: "sh -c 'echo hello'"
    expect: warn

  - name: "warn-shell-wrappers: bash -c"
    tool: Bash
    command: "bash -c 'cat file'"
    expect: warn

  - name: "warn-shell-wrappers: eval"
    tool: Bash
    command: "eval 'printenv'"
    expect: warn

  - name: "warn-shell-wrappers: chained sh -c"
    tool: Bash
    command: "mkdir /tmp && sh -c 'cat /etc/passwd'"
    expect: warn

  - name: "warn-shell-wrappers: allows plain bash"
    tool: Bash
    command: "bash script.sh"
    expect: allow

  # =============================================================================
  # Use Read Tool (warn-use-read-tool)
  # =============================================================================
  - name: "warn-use-read-tool: cat file"
    tool: Bash
    command: "cat README.md"
    expect: warn

  - name: "warn-use-read-tool: cat chained"
    tool: Bash
    command: "cd /workspaces && cat /workspaces/providers.tf"
    expect: warn

  - name: "warn-use-read-tool: head file"
    tool: Bash
    command: "head -n 50 file.txt"
    expect: warn

  - name: "warn-use-read-tool: tail file"
    tool: Bash
    command: "tail -f logfile"
    expect: warn

  - name: "warn-use-read-tool: cat file | grep"
    tool: Bash
    command: "cat file.txt | grep pattern"
    expect: warn

  # =============================================================================
  # Use Grep Tool (warn-use-grep-tool)
  # =============================================================================
  - name: "warn-use-grep-tool: grep pattern"
    tool: Bash
    command: "grep 'TODO' src/"
    expect: warn

  - name: "warn-use-grep-tool: rg pattern"
    tool: Bash
    command: "rg 'function' --type js"
    expect: warn

  # =============================================================================
  # Use Edit Tool (warn-use-edit-tool)
  # =============================================================================
  - name: "warn-use-edit-tool: sed -i"
    tool: Bash
    command: "sed -i 's/old/new/g' file.txt"
    expect: warn

  - name: "warn-use-edit-tool: allows sed without -i"
    tool: Bash
    command: "sed 's/old/new/g' file.txt"
    expect: allow

  # =============================================================================
  # Use Glob Tool (warn-use-glob-tool)
  # =============================================================================
  - name: "warn-use-glob-tool: find path"
    tool: Bash
    command: "find . -name '*.ts'"
    expect: warn

  - name: "warn-use-glob-tool: ls directory"
    tool: Bash
    command: "ls -la src/"
    expect: warn

  - name: "warn-use-glob-tool: allows bare ls"
    tool: Bash
    command: "ls"
    expect: allow

  # =============================================================================
  # Git Commit Workflow (common-block-git-commit-unverified) - repo-specific
  # =============================================================================
  - name: "common-block-git-commit-unverified: git commit -m blocked"
    tool: Bash
    command: "git commit -m 'test message'"
    expect: block

  - name: "common-block-git-commit-unverified: git commit --amend blocked"
    tool: Bash
    command: "git commit --amend"
    expect: block

  - name: "common-block-git-commit-unverified: chained git add && git commit blocked"
    tool: Bash
    command: "git add . && git commit -m 'test'"
    expect: block

  - name: "common-block-git-commit-unverified: command git bypass works"
    tool: Bash
    command: "command git commit -m 'test'"
    expect: allow

  - name: "common-block-git-commit-unverified: chained command git bypass works"
    tool: Bash
    command: "git add . && command git commit -m 'test'"
    expect: allow

  - name: "common-block-git-commit-unverified: prose text not blocked"
    tool: Bash
    command: "gh issue create --title 'convert git commit warning to block'"
    expect: allow

  - name: "common-block-git-commit-unverified: git commit mention without flag not blocked"
    tool: Bash
    command: "echo 'the git commit command is used for committing'"
    expect: allow

  # =============================================================================
  # Git Push Workflow (common-block-git-push) - repo-specific
  # =============================================================================
  - name: "common-block-git-push: git push blocked"
    tool: Bash
    command: "git push"
    expect: block

  - name: "common-block-git-push: git push origin blocked"
    tool: Bash
    command: "git push origin main"
    expect: block

  - name: "common-block-git-push: git push -u blocked"
    tool: Bash
    command: "git push -u origin feature-branch"
    expect: block

  - name: "common-block-git-push: chained git push blocked"
    tool: Bash
    command: "git add . && git commit -m 'test' && git push"
    expect: block

  - name: "common-block-git-push: command git push warns (post-push guidance)"
    tool: Bash
    command: "command git push"
    expect: warn

  - name: "common-block-git-push: command git push -u warns (post-push guidance)"
    tool: Bash
    command: "command git push -u origin main"
    expect: warn

  # =============================================================================
  # Git Directory Flags (common-block-git-directory-flag)
  # =============================================================================
  - name: "common-block-git-directory-flag: git -C blocked"
    tool: Bash
    command: "git -C /some/path status"
    expect: block

  - name: "common-block-git-directory-flag: git --git-dir blocked"
    tool: Bash
    command: "git --git-dir=/some/path/.git status"
    expect: block

  - name: "common-block-git-directory-flag: git --work-tree blocked"
    tool: Bash
    command: "git --work-tree=/some/path status"
    expect: block

  - name: "common-block-git-directory-flag: normal git status allowed"
    tool: Bash
    command: "git status"
    expect: allow

  - name: "common-block-git-directory-flag: git log allowed"
    tool: Bash
    command: "git log --oneline -5"
    expect: allow

  # =============================================================================
  # Git Merge Main/Master (common-block-git-merge-main)
  # =============================================================================
  - name: "common-block-git-merge-main: git merge main blocked"
    tool: Bash
    command: "git merge main"
    expect: block

  - name: "common-block-git-merge-main: git merge master blocked"
    tool: Bash
    command: "git merge master"
    expect: block

  - name: "common-block-git-merge-main: git merge origin/main blocked"
    tool: Bash
    command: "git merge origin/main"
    expect: block

  - name: "common-block-git-merge-main: git merge feature-branch allowed"
    tool: Bash
    command: "git merge feature-branch"
    expect: allow

  # =============================================================================
  # Branch Without Issue (block-branch-without-issue)
  # =============================================================================
  - name: "block-branch-without-issue: git checkout -b without issue blocked"
    tool: Bash
    command: "git checkout -b feat/add-auth"
    expect: block

  - name: "block-branch-without-issue: git branch without issue blocked"
    tool: Bash
    command: "git branch fix/login-bug"
    expect: block

  - name: "block-branch-without-issue: git checkout -b with issue allowed"
    tool: Bash
    command: "git checkout -b feat/add-auth-42"
    expect: allow

  - name: "block-branch-without-issue: git branch with issue allowed"
    tool: Bash
    command: "git branch fix/login-bug-15"
    expect: allow

  - name: "block-branch-without-issue: existing branch checkout allowed"
    tool: Bash
    command: "git checkout main"
    expect: allow

  - name: "block-branch-without-issue: git branch --show-current allowed"
    tool: Bash
    command: "git branch --show-current"
    expect: allow

  # =============================================================================
  # PR Without Issue (block-pr-without-issue)
  # =============================================================================
  - name: "block-pr-without-issue: gh pr create without issue blocked"
    tool: Bash
    command: "gh pr create --title 'feat: add auth' --body 'test'"
    expect: block

  # NOTE: gh pr create with issue# triggers warn from common-warn-pr-create
  - name: "block-pr-without-issue: gh pr create with issue not blocked (but warns)"
    tool: Bash
    command: "gh pr create --title 'feat: add auth (#42)' --body 'test'"
    expect: warn

  - name: "block-pr-without-issue: gh pr create with scope and issue not blocked (but warns)"
    tool: Bash
    command: "gh pr create --title 'feat(api): add endpoint (#15)' --body 'test'"
    expect: warn

  # =============================================================================
  # Warn PR Merge (common-warn-pr-merge)
  # =============================================================================
  - name: "common-warn-pr-merge: gh pr merge triggers warning"
    tool: Bash
    command: "gh pr merge 42"
    expect: warn

  - name: "common-warn-pr-merge: gh pr merge with flags triggers warning"
    tool: Bash
    command: "gh pr merge 42 --squash --delete-branch"
    expect: warn
